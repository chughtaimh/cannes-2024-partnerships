<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannes 2024 Partnership Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .header {
            border-bottom: 1px solid #e5e7eb;
        }
        .tab-active {
            border-bottom: 2px solid #000;
        }
        .partnership-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            background-color: #fff;
            min-width: 150px;
            min-height: 200px;
            max-height: 225px; /* Adjust this value as needed */
        }
		.partnership-card img {
		    width: calc(100% - 32px); /* Full width with some margin */
		    height: 50px; /* Maintain aspect ratio */
		    margin: 0 16px; /* Margin on each side */
		    border-radius: 8px; /* Slightly rounded corners, you can adjust this */
		}
        .submit-button {
            background-color: #ff0000;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
        }
        .grid {
            max-height: 500px; /* Adjust this value as needed */
            overflow-y-scroll;
        }
        .min-h-screen {
            min-height: 100vh;
        }
        .flex-grow {
            flex-grow: 1;
        }
        .overflow-auto {
            overflow: auto;
        }
        .text-xs {
            font-size: 10px;
            font-weight: bold;
            height: 75px;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="max-w-4xl mx-auto p-4 flex flex-col min-h-screen">
        <header class="header flex items-center justify-between py-4">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gray-300 rounded-full mr-4">
                    <img src="/images/logo.jpeg" alt="Partnership Image" class="w-full h-full object-cover rounded-full">
                </div>
                <h1 class="text-2xl font-bold">Cannes 2024 Partnership Tracker</h1>
            </div>
        </header>
        <div class="mt-4 flex-grow">
			<div class="relative">
			    <input type="text" id="searchInput" placeholder="Search Partnerships..." class="w-full p-3 border border-gray-300 rounded-lg" oninput="updateSearchResults(this.value)">
			    <div id="searchDropdown" class="absolute w-full bg-white border border-gray-300 rounded-lg mt-1 z-10 hidden"></div>
			</div>
			<div class="mt-4 flex space-x-4">
			    <button class="tab-active px-4 py-2" onclick="filterPartnerships('All')">All</button>
			    <button class="px-4 py-2" onclick="filterPartnerships('Advanced TV')">Advanced TV</button>
			    <button class="px-4 py-2" onclick="filterPartnerships('Commerce')">Commerce</button>
			</div>
            <div class="grid grid-cols-2 gap-4 overflow-y-scroll" id="partnership-container">
                <!-- Partnership cards will be inserted here -->
            </div>
        </div>
		<script>
		    let partnerships = [];

		    document.addEventListener('DOMContentLoaded', () => {
		        fetchPartnerships();
		    });

		    function fetchPartnerships() {
		        fetch('/partnerships')
		            .then(response => {
		                if (!response.ok) {
		                    throw new Error(`HTTP error! status: ${response.status}`);
		                }
		                return response.json();
		            })
		            .then(data => {
		                partnerships = data;
		                displayPartnerships(data);
		            })
		            .catch(e => {
		                console.error('An error occurred while fetching the partnerships data:', e);
		            });
		    }

		    function displayPartnerships(partnerships) {
		        const container = document.getElementById('partnership-container');
		        container.innerHTML = '';
		        partnerships.forEach(partnership => {
		            const card = document.createElement('div');
		            card.className = 'partnership-card';
		            card.innerHTML = `
		                <div class="w-full h-16 mb-4">
		                    <img src="${partnership.image || '/images/logo.jpeg'}" alt="Partnership Image" class="w-full object-cover">
		                </div>
		                <p class="text-xs font-bold">${partnership.title}</p>
		                <a href="${partnership.link}" target="_blank"><button class="mt-4 text-blue-500">Learn more</button></a>
		            `;
		            container.appendChild(card);
		        });
		    }

		    function filterPartnerships(category) {
		        const buttons = document.querySelectorAll('button');
		        buttons.forEach(button => {
		            if (button.textContent === category) {
		                button.classList.add('tab-active');
		            } else {
		                button.classList.remove('tab-active');
		            }
		        });

		        let query = '';
		        if (category === 'Advanced TV') {
		            query = '?tags=tv';
		        } else if (category === 'Commerce') {
		            query = '?tags=commerce';
		        }

		        fetch(`/partnerships${query}`)
		            .then(response => {
		                if (!response.ok) {
		                    throw new Error(`HTTP error! status: ${response.status}`);
		                }
		                return response.json();
		            })
		            .then(data => {
		                displayPartnerships(data);
		            })
		            .catch(e => {
		                console.error('An error occurred while fetching the partnerships data:', e);
		            });
		    }

		    function updateSearchResults(query) {
		        const dropdown = document.getElementById('searchDropdown');
		        if (query.length === 0) {
		            dropdown.classList.add('hidden');
		            return;
		        }

		        const matchingPartnerships = partnerships.filter(p => p.desc.toLowerCase().includes(query.toLowerCase()));
		        dropdown.innerHTML = '';
		        
		        if (matchingPartnerships.length > 0) {
		            matchingPartnerships.forEach(partnership => {
		                const item = document.createElement('div');
		                item.className = 'p-2 hover:bg-gray-100 cursor-pointer';
		                item.textContent = partnership.title;
		                item.onclick = () => {
		                    document.getElementById('searchInput').value = partnership.title;
		                    filterPartnershipsById(partnership.id);
		                    dropdown.classList.add('hidden');
		                };
		                dropdown.appendChild(item);
		            });
		            dropdown.classList.remove('hidden');
		        } else {
		            dropdown.classList.add('hidden');
		        }
		    }

		    function filterPartnershipsById(id) {
		        const container = document.getElementById('partnership-container');
		        container.innerHTML = '';
		        const partnership = partnerships.find(p => p.id === id);
		        if (partnership) {
		            const card = document.createElement('div');
		            card.className = 'partnership-card';
		            card.innerHTML = `
		                <div class="w-full h-16 mb-4">
		                    <img src="${partnership.image || '/images/logo.jpeg'}" alt="Partnership Image" class="w-full object-cover">
		                </div>
		                <p class="text-xs font-bold">${partnership.title}</p>
		                <a href="${partnership.link}" target="_blank"><button class="mt-4 text-blue-500">Learn more</button></a>
		            `;
		            container.appendChild(card);
		        }
		    }
		</script>
		<!-- POPUP: ADD PARTNERSHIP -->
		<div id="popupModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center hidden">
    		<div class="bg-white p-8 rounded-lg w-full max-w-lg min-w-xs" style="max-width: 500px;">
		        <h2 class="text-xl font-bold mb-4">Submit New Partnership</h2>
		        <input type="text" id="partnershipURL" placeholder="Enter partnership URL" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
		        <div id="urlError" class="text-red-500 hidden">Please enter a valid URL</div>
		        <div class="flex justify-end">
		            <button onclick="submitURL()" class="submit-button">Submit</button>
		            <button onclick="closePopup()" class="ml-4 text-gray-500">Cancel</button>
		        </div>
		    </div>
		</div>

		<!-- SCRIPT FOR HANDLING ADD NEW PARTNERSHIP -->
		<script>
		    // Show the popup
		    function showForm() {
		        document.getElementById('popupModal').classList.remove('hidden');
		    }

		    // Close the popup
		    function closePopup() {
		        document.getElementById('partnershipURL').value = '';
		        document.getElementById('urlError').classList.add('hidden');
		        document.getElementById('popupModal').classList.add('hidden');
		    }

		    // Validate URL
		    function isValidURL(url) {
		        const pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
		            '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|'+ // domain name
		            '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
		            '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
		            '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
		            '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
		        return !!pattern.test(url);
		    }

		    // Handle URL submission
		    function submitURL() {
		        const url = document.getElementById('partnershipURL').value;
		        if (!isValidURL(url)) {
		            document.getElementById('urlError').classList.remove('hidden');
		            return;
		        }

		        // Proceed to the next step (fetching article details and sending to backend)
		        fetchArticleDetails(url);
		    }

		    // Fetch article details from backend
		    async function fetchArticleDetails(url) {
		        try {
		            const response = await fetch('/fetch-article-details', {
		                method: 'POST',
		                headers: {
		                    'Content-Type': 'application/json',
		                },
		                body: JSON.stringify({ url }),
		            });
		            console.log(response)

		            if (!response.ok) {
		                throw new Error('Failed to fetch article details');
		            }

		            const articleDetails = await response.json();
		            displayPartnershipProposal(articleDetails);

		        } catch (error) {
		            console.error('Error fetching article details:', error);
		            alert('Failed to fetch article details. Please try again.');
		        }
		    }

		    // Display partnership proposal
		    function displayPartnershipProposal(proposal) {
		        // Clear existing popup content and display the proposal
		        const popupContent = document.getElementById('popupModal');
		        popupContent.innerHTML = `
    		<div class="bg-white p-8 rounded-lg w-full max-w-lg min-w-xs" style="max-width: 500px;">

	            <h2 class="text-xl font-bold mb-4">Review Partnership</h2>
	            <p><strong>Title:</strong> ${proposal.title}</p>
	            <p><strong>Description:</strong> ${proposal.desc}</p>
	            <p><strong>Link:</strong> <a href="${proposal.link}" target="_blank">${proposal.link}</a></p>
	            <img src="${proposal.image}" alt="Partnership Image" class="w-full h-64 object-cover my-4">
	            <div class="flex justify-end">
	                <button onclick="approvePartnership(${JSON.stringify(proposal).replace(/"/g, '&quot;')})" class="submit-button">Approve</button>
	                <button onclick="disapprovePartnership()" class="ml-4 text-gray-500">Disapprove</button>
	            </div>
	        </div>
		        `;
		    }
		    // Disapprove partnership
			function disapprovePartnership() {
			    // closePopup();
			    location.reload();  // Refresh the page
			}

			// Approve partnership
			async function approvePartnership(proposal) {
			    try {
			        // Fetch existing companies
			        const companiesResponse = await fetch('/companies');
			        if (!companiesResponse.ok) {
			            throw new Error('Failed to fetch companies');
			        }
			        const companies = await companiesResponse.json();

			        // Helper function to get or create company
			        async function getOrCreateCompany(companyName) {
			            let company = companies.find(c => c.name === companyName);
			            if (!company) {
			                const newCompanyResponse = await fetch('/companies', {
			                    method: 'POST',
			                    headers: {
			                        'Content-Type': 'application/json',
			                    },
			                    body: JSON.stringify({ name: companyName, logo: '/images/logo.jpeg' }),
			                });
			                if (!newCompanyResponse.ok) {
			                    throw new Error(`Failed to create company ${companyName}`);
			                }
			                company = await newCompanyResponse.json();
			            }
			            return company.cid;
			        }

			        // Get or create companies and update proposal
			        proposal.company_one = await getOrCreateCompany(proposal.company_one);
			        proposal.company_two = await getOrCreateCompany(proposal.company_two);

			        // Submit the partnership
			        const response = await fetch('/partnerships', {
			            method: 'POST',
			            headers: {
			                'Content-Type': 'application/json',
			            },
			            body: JSON.stringify(proposal),
			        });

			        if (!response.ok) {
			            throw new Error('Failed to submit partnership');
			        }

			        // Show loading image
			        document.getElementById('popupModal').innerHTML += '<img src="images/loading.gif" alt="Loading...">';

			        alert('Partnership submitted successfully');
			        location.reload();  // Refresh the page
			    } catch (error) {
			        console.error('Error submitting partnership:', error);
			        alert('Failed to submit partnership. Please try again.');
			    }
			}



		</script>

        <div class="mt-8 text-center">
            <div class="submit-button" onclick="showForm()">SUBMIT NEW PARTNERSHIP</div>
        </div>
        <footer class="mt-8 text-center text-gray-600">
            <p>Cannes 2024 Partnership Tracker (c)</p>
            <div class="flex justify-center space-x-4 mt-2">
                <a href="#" class="text-blue-500">Privacy</a>
                <a href="#" class="text-blue-500">About</a>
                <a href="#" class="text-blue-500">Contact</a>
            </div>
        </footer>
    </div>
</body>

</html>
